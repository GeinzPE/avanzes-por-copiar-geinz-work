package com.geinzz.geinzwork.ui.adapters.ui.dialog_general

import android.Manifest
import android.app.Activity
import android.app.Instrumentation
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.text.Layout
import android.util.Log

import android.widget.Toast
import androidx.activity.compose.ManagedActivityResultLauncher
import androidx.activity.result.ActivityResult
import androidx.activity.result.IntentSenderRequest
import androidx.compose.foundation.Image
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Switch
import androidx.compose.material3.SwitchDefaults
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.ColorFilter
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.DialogProperties
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.geinzz.geinzwork.R
import com.geinzz.geinzwork.data.model.msjes_predeteminados_generales
import com.geinzz.geinzwork.model.open_apps.fb_tk_ig.open_fb_tk_ig.abrir_whattsapp
import com.geinzz.geinzwork.model.repo_seguridad_salud
import com.geinzz.geinzwork.ui.adapters.ui.COMP_principal_filtrado.TextoSubrayado
import com.geinzz.geinzwork.ui.adapters.ui.COMP_principal_filtrado.texto_generico_multilinea
import com.geinzz.geinzwork.ui.adapters.ui.COMP_principal_filtrado.texto_generico_one_line
import com.geinzz.geinzwork.utils.constantes.constantes.constantestextos_general.copiarTexto_portapapeles_compouse
import com.geinzz.geinzwork.utils.constantes.localizate_geinz.constantes_lista_localidades.FuenteControladaApp
import com.geinzz.geinzwork.utils.constantes.localizate_geinz.constantes_lista_localidades.verificarGPS
import com.geinzz.geinzwork.utils.localizate_geinz.verificarUbiActiva
import com.geinzz.geinzwork.viewModels.viewmode_seguridad_salud
import com.google.android.gms.location.FusedLocationProviderClient
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import java.net.URLEncoder


val REQUEST_CALL_PHONE = 1

@Composable
fun dialog_llamada_urgencias(
    img_entidad:String,
    nombre_entidad_seletc: String,
    launcher_dialog_ubicacion: ManagedActivityResultLauncher<IntentSenderRequest, ActivityResult>,
    permision_obtener_cordenadas: ManagedActivityResultLauncher<String, Boolean>,
    fusedLocationClient: FusedLocationProviderClient,
    viewmodeSeguridadSalud: viewmode_seguridad_salud,
    lista_numeros: List<String>,
    tipo: String,
    ondimiss: () -> Unit
) {
    val context = LocalContext.current
    var call_dialog_permise by rememberSaveable { mutableStateOf(false) }
    var numero_llamada by rememberSaveable { mutableStateOf("") }
    val repo_seguridad__salud = repo_seguridad_salud()
    val es_una_emergencia_conctactar by viewmodeSeguridadSalud.es_una_emergegecia.collectAsState()
    var texto_emergencia by remember { mutableStateOf("") }
    var enviar_msje_con_ubicacion by remember { mutableStateOf(false) }
    var ofuscar_btns_acces by remember { mutableStateOf(false) }
    var msje_general_whatsapp by remember { mutableStateOf("") }


    LaunchedEffect(enviar_msje_con_ubicacion) {
        if (enviar_msje_con_ubicacion) {
            CoroutineScope(Dispatchers.Main).launch {
                try {
                    if (ContextCompat.checkSelfPermission(
                            context,
                            Manifest.permission.ACCESS_FINE_LOCATION
                        ) != PackageManager.PERMISSION_GRANTED
                    ) {
                        permision_obtener_cordenadas.launch(Manifest.permission.ACCESS_FINE_LOCATION)
                        return@launch

                    } else {
                        if (verificarUbiActiva(context)) {
                            ofuscar_btns_acces = true

                            val datosConCallback =
                                repo_seguridad__salud.obtenerUbicacionUsuarioCancelable(
                                    fusedLocationClient
                                )
                            val datos = datosConCallback.latLng
                            if(datos.latitude==0.0 && datos.longitude==0.0){
                                enviar_msje_con_ubicacion=false
                                Toast.makeText(context, "no se pudo obtener tu ubicacion vuelvelo a intenetar", Toast.LENGTH_SHORT).show()
                                return@launch
                            }
                            val url_maps =
                                "https://www.google.com/maps/dir/?api=1&destination=${datos.latitude},${datos.longitude}"
                            repo_seguridad__salud.cancelarUbicacion(
                                fusedLocationClient,
                                datosConCallback.callback
                            )
                            ofuscar_btns_acces = false

                            msje_general_whatsapp = """
                                                            ðŸš¨ EMERGENCIA REAL ðŸš¨
                                                            Me encuentro en esta ubicaciÃ³n:
                                                            $url_maps
                                                            Necesito apoyo rÃ¡pidamente.
                                                            Geinz
                                                        """.trimIndent()
                            Log.d("corednasd_opbtenidas", "$datos")

                        } else {
                            verificarGPS(
                                context,
                                launcher_dialog_ubicacion
                            )
                            return@launch
                        }
                    }
                } catch (e: Exception) {
                    Log.d("error", "error al obtener las cordenadas")
                }
            }
        }
    }

    AlertDialog(
        onDismissRequest = { ondimiss() },
        confirmButton = {},
        dismissButton = {},
        title = {
            FuenteControladaApp {
                texto_generico_one_line("NÃºmeros de emergencia")
            }
        },
        text = {
            FuenteControladaApp {
                Column(verticalArrangement = Arrangement.spacedBy(10.dp)) {
                    if (tipo.equals("whatsapp")) {
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(5.dp)
                        ) {
                            TextoSubrayado(
                                "Compartir ubicacion con $nombre_entidad_seletc",
                                modifier = Modifier.weight(1f),
                                color_subrallado = MaterialTheme.colorScheme.primary
                            )
                            Switch(
                                checked = enviar_msje_con_ubicacion,
                                onCheckedChange = { value ->
                                    enviar_msje_con_ubicacion = value
                                }, colors = SwitchDefaults.colors(
                                    checkedThumbColor = MaterialTheme.colorScheme.primary,
                                    checkedTrackColor = MaterialTheme.colorScheme.primary.copy(alpha = 0.5f),
                                    uncheckedThumbColor = MaterialTheme.colorScheme.outline,
                                    uncheckedTrackColor = MaterialTheme.colorScheme.outline.copy(
                                        alpha = 0.3f
                                    )
                                )
                            )
                        }
                    }

                    texto_generico_multilinea(
                        "En caso de emergencia, comunÃ­cate de inmediato con los servicios de seguridad y salud.Puedes llamar o ir a whatsApp directamente tocando el Ã­cono de telÃ©fono o copiar el nÃºmero que necesites.",
                        MaterialTheme.typography.bodyMedium
                    )
                    if (!ofuscar_btns_acces) {
                        lista_numeros.forEach { i ->
                            box_llamada_whatsap(
                                i, tipo,
                                click_icon = {
                                    if (tipo.equals("whatsapp")) {

                                        CoroutineScope(Dispatchers.Main).launch {
                                            if (es_una_emergencia_conctactar) {
                                                enviarMensajeEmergencia(
                                                    fusedLocationClient,
                                                    repo_seguridad__salud,
                                                    onMensajeListo = { msj ->
                                                        abrir_whattsapp(
                                                            "",
                                                            tipo = "",
                                                            id_tienda = "",
                                                            localidad_tienda = "",
                                                            context = context,
                                                            numero = "937659216",
                                                            mensajePredefinido = msj
                                                        )

                                                    })


                                            } else {
                                                // ðŸ”¥ Solo abre WhatsApp sin texto
                                                val texto_a_enviar_diretamte =
                                                    if (enviar_msje_con_ubicacion) {
                                                        msje_general_whatsapp
                                                    } else {
                                                        ""
                                                    }
                                                val textoCodificado = URLEncoder.encode(
                                                    texto_a_enviar_diretamte,
                                                    "UTF-8"
                                                )

                                                Log.d("datos_a_pasr", "$texto_a_enviar_diretamte")
                                                val uri = Uri.parse(
                                                    "https://api.whatsapp.com/send?phone=+51937659216&text=$textoCodificado"
                                                )

                                                val intent = Intent(Intent.ACTION_VIEW, uri)
                                                context.startActivity(intent)
                                            }
                                        }
                                    } else if (tipo.equals("llamada")) {
                                        if (ContextCompat.checkSelfPermission(
                                                context,
                                                Manifest.permission.CALL_PHONE
                                            ) != PackageManager.PERMISSION_GRANTED
                                        ) {
                                            call_dialog_permise = true
                                            numero_llamada = i
                                        } else {
                                            makePhoneCall(context, i)
                                        }
                                    }
                                },
                                click_copiar = { copiarTexto_portapapeles_compouse(i, context) })

                        }
                    } else {
                        texto_generico_one_line("obteniendo tu ubicacion...")
                    }

                }
            }
        },
        shape = RoundedCornerShape(20.dp),
        icon = {
            Image(
                painter = painterResource(if (tipo.equals("whatsapp")) R.drawable.whatsapp_icon else R.drawable.llamada_icon),
                contentDescription = "", modifier = Modifier.size(30.dp)
            )
        },

        )
    if (call_dialog_permise) {
        permisos_llamadas(aceptar_permisos = {
            requestCallPermission(context = context, phoneNumber = numero_llamada)
        }, ondimis = {
            call_dialog_permise = false
        })
    }
}

fun enviarMensajeEmergencia(
    fusedLocationClient: FusedLocationProviderClient,
    repo_seguridad__salud: repo_seguridad_salud, // tu repo que maneja ubicaciÃ³n
    onMensajeListo: (String) -> Unit
) {
    CoroutineScope(Dispatchers.Main).launch {
        try {
            // Obtener ubicaciÃ³n
            val datosConCallback =
                repo_seguridad__salud.obtenerUbicacionUsuarioCancelable(fusedLocationClient)
            val datos = datosConCallback.latLng

            // Cancelar la actualizaciÃ³n de ubicaciÃ³n
            repo_seguridad__salud.cancelarUbicacion(fusedLocationClient, datosConCallback.callback)

            // Generar link de Google Maps
            val linkUbicacion =
                "https://www.google.com/maps/dir/?api=1&destination=${datos.latitude},${datos.longitude}"

            // Armar mensaje final
            val mensajeFinal = """
                ðŸš¨ EMERGENCIA REAL ðŸš¨
                Me encuentro en esta ubicaciÃ³n:
                $linkUbicacion
                Necesito apoyo rÃ¡pidamente.
                Geinz
            """.trimIndent()

            // Retornar mensaje
            onMensajeListo(mensajeFinal)
        } catch (e: Exception) {
            e.printStackTrace()
            onMensajeListo("No se pudo obtener la ubicaciÃ³n. âŒ")
        }
    }
}

@Composable
fun box_llamada_whatsap(
    numero: String,
    tipo: String,
    click_icon: () -> Unit,
    click_copiar: () -> Unit
) {
    FuenteControladaApp {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            modifier = Modifier.padding(vertical = 8.dp)
        ) {
            texto_generico_one_line(
                numero,
                style = MaterialTheme.typography.bodyMedium,
                modifier = Modifier.weight(1f)
            )
            Row() {
                Image(
                    painter = painterResource(if (tipo.equals("whatsapp")) R.drawable.whatsapp_icon else R.drawable.llamada_icon),
                    contentDescription = "", modifier = Modifier
                        .size(25.dp)
                        .clickable(
                            indication = null,
                            interactionSource = remember { MutableInteractionSource() }
                        ) { click_icon() }
                )
                spacer_horizonta(10.dp)
                Image(
                    painter = painterResource(R.drawable.baseline_content_copy_24),
                    contentDescription = "",
                    modifier = Modifier
                        .size(25.dp)
                        .clickable(
                            indication = null,
                            interactionSource = remember { MutableInteractionSource() }
                        ) { click_copiar() },
                    colorFilter = ColorFilter.tint(Color.White)
                )
            }
        }
    }

}

fun requestCallPermission(llamar: Boolean = true, context: Context, phoneNumber: String = "") {
    if (ContextCompat.checkSelfPermission(
            context,
            android.Manifest.permission.CALL_PHONE
        ) != PackageManager.PERMISSION_GRANTED
    ) {
        ActivityCompat.requestPermissions(
            context as Activity,
            arrayOf(android.Manifest.permission.CALL_PHONE),
            REQUEST_CALL_PHONE
        )
    } else {
        if (llamar) {
            makePhoneCall(context, phoneNumber)
        }
    }
}

fun makePhoneCall(context: Context, phoneNumber: String) {
    val callIntent = Intent(Intent.ACTION_CALL)
    callIntent.data = Uri.parse("tel:$phoneNumber")
    if (ActivityCompat.checkSelfPermission(
            context,
            android.Manifest.permission.CALL_PHONE
        ) == PackageManager.PERMISSION_GRANTED
    ) {
        context.startActivity(callIntent)
    } else {
        requestCallPermission(context = context, phoneNumber = phoneNumber)
    }
}